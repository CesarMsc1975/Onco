export default function PatientForm({
  mode,
  // estados/sets del paciente (puedes ir migrando luego a un objeto)
  identifierTypeCode, setIdentifierTypeCode,
  identifierValue, setIdentifierValue,
  identifierPaisEmision, setIdentifierPaisEmision,
  nombreOficialFamily, setNombreOficialFamily,
  nombreOficialSegundoApellido, setNombreOficialSegundoApellido,
  nombreOficialGiven, setNombreOficialGiven,
  gender, setGender,
  identidadGenero, setIdentidadGenero,
  birthDate, setBirthDate,
  deceasedBoolean, setDeceasedBoolean,
  nacionalidad, setNacionalidad,
  paisOrigen, setPaisOrigen,
  pueblosOriginariosPerteneciente, setPueblosOriginariosPerteneciente,
  telecomSystem, setTelecomSystem,
  telecomValue, setTelecomValue,

  // lookups
  tipoIdentificadorOptions,
  identidadGeneroOptions,
  paisesOptions,

  // acciones
  onGenerarJson,
  onValidate,
  onCreate,
  onVolverBusqueda,

  // salidas
  jsonPatient,
  validateOutcome,
  validateResult,
  createResult,
  createResponseRaw,

  // flags
  canValidate,
  isValidating,
  canCreate,
  isCreating
}) {
  return (
    <>
      {activeTab === "patient" && (
    <form
      onSubmit={(e) => { e.preventDefault(); handleGenerarPatient(); }}
      style={{
        textAlign: "left",
        maxWidth: 900,
        margin: "0 auto",
        background: "#fff",
        color: "#111",
        padding: 18,
        borderRadius: 12,
        boxShadow: "0 10px 30px rgba(0,0,0,0.15)"
      }}
    >
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
        <div>
          <h3 style={{ margin: 0 }}>
             {mode === "edit" ? "Paciente encontrado (editar)" : "Nuevo paciente"}
          </h3>
          <div style={{ fontSize: 12, opacity: 0.75 }}>
            Campos requeridos + extensiones
          </div>
        </div>

        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <button type="submit" style={{ padding: "8px 12px", borderRadius: 10, border: "1px solid #ddd", cursor: "pointer" }}>
            Generar JSON
          </button>

          <button
            type="button"
            onClick={handleValidatePatient}
            disabled={!canValidate || isValidating}
            style={{ padding: "8px 12px", borderRadius: 10, border: "1px solid #ddd", cursor: "pointer", opacity: (!canValidate || isValidating) ? 0.6 : 1 }}
          >
            {isValidating ? "Validando..." : "Validar en servidor ($validate)"}
          </button>

          <button
            type="button"
            onClick={handleLimpiar}
            style={{ padding: "8px 12px", borderRadius: 10, border: "1px solid #ddd", cursor: "pointer" }}
          >
            Limpiar
          </button>

          <button
            type="button"
            onClick={() => setScreen("search")}
            style={{ padding: "8px 12px", borderRadius: 10, border: "1px solid #ddd", cursor: "pointer" }}
          >
            Volver a b√∫squeda
          </button>
        </div>
      </div>

      {/* GRID PRINCIPAL (2 columnas) */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14, marginTop: 16 }}>

        {/* Identificaci√≥n */}
        <fieldset style={{ border: "1px solid #e5e5e5", borderRadius: 12, padding: 12 }}>
          <legend style={{ padding: "0 8px" }}><strong>Identificaci√≥n</strong></legend>

          <div style={{ display: "grid", gridTemplateColumns: "160px 1fr", gap: 10, alignItems: "center" }}>
            {/* NO lo borramos, lo dejamos comentado */}
            {/*
            <label>ID (FHIR):</label>
            <input value={id} onChange={e => setId(e.target.value)} placeholder="No necesario (server asigna)" />
            */}

            <label>Tipo identificador:</label>
            <select value={identifierTypeCode} onChange={e => setIdentifierTypeCode(e.target.value)} required>
              <option value="">Seleccione...</option>
              {tipoIdentificadorOptions.map(opt => (
                <option key={opt.code} value={opt.code}>{opt.display}</option>
              ))}
            </select>

            <label>Identificador (value):</label>
            <input value={identifierValue} onChange={e => setIdentifierValue(e.target.value)} required placeholder="Ej: 12.345.678-9" />

            <label>Pa√≠s emisi√≥n ID:</label>
            <select value={identifierPaisEmision} onChange={e => setIdentifierPaisEmision(e.target.value)} required>
              <option value="">Seleccione...</option>
              {paisesOptions.map(opt => (
                <option key={opt.code} value={opt.code}>{opt.display}</option>
              ))}
            </select>
          </div>
        </fieldset>

        {/* Nombre */}
        <fieldset style={{ border: "1px solid #e5e5e5", borderRadius: 12, padding: 12 }}>
          <legend style={{ padding: "0 8px" }}><strong>Nombre</strong></legend>

          <div style={{ display: "grid", gridTemplateColumns: "160px 1fr", gap: 10, alignItems: "center" }}>
            <label>Primer apellido:</label>
            <input value={nombreOficialFamily} onChange={e => setNombreOficialFamily(e.target.value)} required />

            <label>Segundo apellido:</label>
            <input value={nombreOficialSegundoApellido} onChange={e => setNombreOficialSegundoApellido(e.target.value)} />

            <label>Nombres:</label>
            <input value={nombreOficialGiven} onChange={e => setNombreOficialGiven(e.target.value)} required />
          </div>
        </fieldset>

        {/* Demograf√≠a */}
        <fieldset style={{ border: "1px solid #e5e5e5", borderRadius: 12, padding: 12 }}>
          <legend style={{ padding: "0 8px" }}><strong>Demograf√≠a y origen</strong></legend>

          <div style={{ display: "grid", gridTemplateColumns: "160px 1fr", gap: 10, alignItems: "center" }}>
            <label>Sexo (gender):</label>
            <select value={gender} onChange={e => setGender(e.target.value)} required>
              <option value="">Seleccione...</option>
              <option value="male">Masculino</option>
              <option value="female">Femenino</option>
              <option value="other">Otro</option>
              <option value="unknown">Desconocido</option>
            </select>

            <label>Identidad de g√©nero:</label>
            <select value={identidadGenero} onChange={e => setIdentidadGenero(e.target.value)} required>
              <option value="">Seleccione...</option>
              {identidadGeneroOptions.map(opt => (
                <option key={opt.code} value={opt.code}>{opt.display}</option>
              ))}
            </select>

            <label>Fecha nacimiento:</label>
            <input type="date" value={birthDate} onChange={e => setBirthDate(e.target.value)} required />

            <label>¬øFallecido?:</label>
            <input type="checkbox" checked={deceasedBoolean} onChange={e => setDeceasedBoolean(e.target.checked)} />

            <label>Nacionalidad:</label>
            <select value={nacionalidad} onChange={e => setNacionalidad(e.target.value)} required>
              <option value="">Seleccione...</option>
              {paisesOptions.map(opt => (
                <option key={opt.code} value={opt.code}>{opt.display}</option>
              ))}
            </select>

            <label>Pa√≠s de origen:</label>
            <select value={paisOrigen} onChange={e => setPaisOrigen(e.target.value)} required>
              <option value="">Seleccione...</option>
              {paisesOptions.map(opt => (
                <option key={opt.code} value={opt.code}>{opt.display}</option>
              ))}
            </select>

            <label>Pueblos originarios:</label>
            <label style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <input
                type="checkbox"
                checked={pueblosOriginariosPerteneciente}
                onChange={e => setPueblosOriginariosPerteneciente(e.target.checked)}
              />
              Pertenece
            </label>
          </div>
        </fieldset>

        {/* Contacto */}
        <fieldset style={{ border: "1px solid #e5e5e5", borderRadius: 12, padding: 12 }}>
          <legend style={{ padding: "0 8px" }}><strong>Contacto</strong></legend>

          <div style={{ display: "grid", gridTemplateColumns: "160px 1fr", gap: 10, alignItems: "center" }}>
            <label>Canal:</label>
            <select value={telecomSystem} onChange={e => setTelecomSystem(e.target.value)}>
              <option value="phone">Tel√©fono</option>
              <option value="email">Email</option>
            </select>

            <label>Valor:</label>
            <input
              value={telecomValue}
              onChange={e => setTelecomValue(e.target.value)}
              required
              placeholder={telecomSystem === "email" ? "nombre@dominio.cl" : "+56 9 1234 5678"}
            />
          </div>
        </fieldset>
      </div>

      {/* JSON preview */}
      {jsonPatient && (
  <div style={{ marginTop: 16 }}>
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
      <strong>JSON generado</strong>
      <button
        type="button"
        onClick={() => navigator.clipboard?.writeText(JSON.stringify(jsonPatient, null, 2))}
      >
        Copiar
      </button>
    </div>

    <pre style={{ marginTop: 10, background: "#0f172a", color: "#e2e8f0", padding: 12, borderRadius: 12, overflow: "auto" }}>
      {JSON.stringify(jsonPatient, null, 2)}
    </pre>

    {/* üëá BOT√ìN CREAR FICHA VA AQU√ç */}
    <div style={{ marginTop: 12, display: "flex", justifyContent: "flex-end" }}>
      {mode === "create" && (
        <button type="button" onClick={handleCreateFicha} disabled={isCreating || !jsonPatient}>
          {isCreating ? "Creando..." : "Crear ficha"}
        </button>
      )}

      
      {createResult && (
  <div style={{ marginTop: 12, padding: 10, borderRadius: 10, background: "#f3f4f6", color: "#111" }}>
    <strong style={{ color: createResult.ok ? "green" : "crimson" }}>
      {createResult.summary}
    </strong>

    {createResult.location && (
      <div style={{ marginTop: 6, fontSize: 12 }}>
        <div><b>Location:</b> {createResult.location}</div>
        {createResult.id && <div><b>ID:</b> {createResult.id}</div>}
      </div>
    )}

    {/* Bot√≥n para volver solo cuando t√∫ quieras */}
    <div style={{ marginTop: 10, display: "flex", gap: 8 }}>
      <button type="button" onClick={() => { handleLimpiar(); setScreen("search"); }}>
        Volver a b√∫squeda
      </button>
    </div>
  </div>
)}

{createResponseRaw && (
  <pre style={{ marginTop: 10, background: "#111", color: "#e2e8f0", padding: 12, borderRadius: 12, overflow: "auto" }}>
    {createResponseRaw}
  </pre>
)}

  
  


    </div>
  </div>
    )}


      {/* Resultado validaci√≥n */}
      {validateResult && (
        <div style={{ marginTop: 15 }}>
          <strong>{validateResult.summary}</strong>
        </div>
      )}

      {validateOutcome && (
        <pre style={{ marginTop: 10, background: "#111", color: "#e2e8f0", padding: 12, borderRadius: 12, overflow: "auto" }}>
          {JSON.stringify(validateOutcome, null, 2)}
        </pre>
      )}

      

   
      <div style={{ marginTop: 14, display: "flex", justifyContent: "flex-end", gap: 10 }}>
      <button
        type="button"
        onClick={handleCreateFicha}
        disabled={isCreating || !jsonPatient}
        style={{
          padding: "10px 14px",
          borderRadius: 10,
          border: "1px solid #ddd",
          cursor: "pointer",
          opacity: (isCreating || !jsonPatient) ? 0.6 : 1
        }}
      >
        {isCreating ? "Creando..." : "Crear ficha"}
      </button>
    </div>


      {/* ‚ÄúCSS‚Äù m√≠nimo para inputs (NO BORRAR) */}
      <style>{`
        input, select {
          width: 100%;
          padding: 10px 10px;
          border-radius: 10px;
          border: 1px solid #dcdcdc;
          outline: none;
          box-sizing: border-box;
          min-width: 0;
        }
        input:focus, select:focus {
          border-color: #94a3b8;
          box-shadow: 0 0 0 3px rgba(148,163,184,0.25);
        }
        fieldset { background: #fafafa; }
      `}</style>
    </form>
  )}
    </>
  );
}